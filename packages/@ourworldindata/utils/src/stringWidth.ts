/**
 * This file contains an adapted version of https://github.com/adambisek/string-pixel-width,
 * just with the character widths hardcoded for our two main fonts (Lato and Playfair Display).
 * It can be used to roughly estimate the width of a string in pixels.
 */

// We have pixel width data for all ASCII characters, plus the following:
// ‑–—…‘’“”°→≤≥£⁰₀¹₁²₂³₃⁴₄⁵₅⁶₆⁷₇⁸₈⁹₉ºµ

export enum FontFamily {
    Lato = "Lato",
    PlayfairDisplay = "PlayfairDisplay",
}

// Variant indices: 0=regular, 1=bold, 2=italic, 3=bold+italic
// Pre-flattened maps: widthsMap[font][variant][char] -> width in pixels
const widthsMap: Record<FontFamily, Record<string, number>[]> = {
    [FontFamily.Lato]: [
        // regular
        {
            "0": 58,
            "1": 58,
            "2": 58,
            "3": 58,
            "4": 58,
            "5": 58,
            "6": 58,
            "7": 58,
            "8": 58,
            "9": 58,
            " ": 26,
            "!": 27,
            '"': 37,
            "#": 58,
            $: 58,
            "%": 80,
            "&": 71,
            "'": 20,
            "(": 27,
            ")": 27,
            "*": 43,
            "+": 58,
            ",": 23,
            "-": 37,
            ".": 24,
            "/": 45,
            ":": 25,
            ";": 26,
            "<": 58,
            "=": 58,
            ">": 58,
            "?": 45,
            "@": 84,
            A: 68,
            B: 65,
            C: 67,
            D: 76,
            E: 58,
            F: 57,
            G: 73,
            H: 76,
            I: 28,
            J: 42,
            K: 66,
            L: 51,
            M: 93,
            N: 76,
            O: 80,
            P: 60,
            Q: 80,
            R: 63,
            S: 54,
            T: 59,
            U: 74,
            V: 68,
            W: 104,
            X: 65,
            Y: 62,
            Z: 60,
            "[": 31,
            "\\": 45,
            "]": 31,
            "^": 58,
            _: 46,
            "`": 40,
            a: 50,
            b: 56,
            c: 48,
            d: 56,
            e: 53,
            f: 35,
            g: 52,
            h: 56,
            i: 24,
            j: 24,
            k: 51,
            l: 24,
            m: 82,
            n: 56,
            o: 57,
            p: 56,
            q: 56,
            r: 36,
            s: 43,
            t: 36,
            u: 56,
            v: 52,
            w: 79,
            x: 50,
            y: 52,
            z: 45,
            "{": 30,
            "|": 25,
            "}": 30,
            "~": 58,
            "₀": 33,
            "₁": 33,
            "₂": 33,
            "₃": 33,
            "₄": 33,
            "₅": 33,
            "₆": 33,
            "₇": 33,
            "₈": 33,
            "₉": 33,
            "⁰": 33,
            "¹": 33,
            "²": 33,
            "³": 33,
            "⁴": 33,
            "⁵": 33,
            "⁶": 33,
            "⁷": 33,
            "⁸": 33,
            "⁹": 33,
            "‑": 37,
            "–": 58,
            "—": 79,
            "…": 75,
            "‘": 21,
            "’": 21,
            "“": 37,
            "”": 37,
            "°": 41,
            "→": 100,
            "≤": 58,
            "≥": 58,
            "£": 58,
            º: 40,
            µ: 65,
        },
        // bold
        {
            "0": 58,
            "1": 58,
            "2": 58,
            "3": 58,
            "4": 58,
            "5": 58,
            "6": 58,
            "7": 58,
            "8": 58,
            "9": 58,
            " ": 24,
            "!": 28,
            '"': 40,
            "#": 58,
            $: 58,
            "%": 82,
            "&": 72,
            "'": 21,
            "(": 27,
            ")": 27,
            "*": 43,
            "+": 58,
            ",": 23,
            "-": 37,
            ".": 24,
            "/": 47,
            ":": 26,
            ";": 27,
            "<": 58,
            "=": 58,
            ">": 58,
            "?": 46,
            "@": 84,
            A: 69,
            B: 66,
            C: 66,
            D: 76,
            E: 58,
            F: 57,
            G: 73,
            H: 77,
            I: 30,
            J: 43,
            K: 69,
            L: 52,
            M: 95,
            N: 77,
            O: 81,
            P: 62,
            Q: 81,
            R: 64,
            S: 55,
            T: 60,
            U: 74,
            V: 69,
            W: 105,
            X: 67,
            Y: 65,
            Z: 61,
            "[": 31,
            "\\": 47,
            "]": 31,
            "^": 58,
            _: 47,
            "`": 40,
            a: 51,
            b: 57,
            c: 48,
            d: 57,
            e: 53,
            f: 36,
            g: 53,
            h: 56,
            i: 25,
            j: 25,
            k: 53,
            l: 25,
            m: 84,
            n: 56,
            o: 57,
            p: 57,
            q: 57,
            r: 37,
            s: 44,
            t: 37,
            u: 56,
            v: 53,
            w: 80,
            x: 52,
            y: 53,
            z: 46,
            "{": 31,
            "|": 26,
            "}": 31,
            "~": 58,
            "₀": 33,
            "₁": 33,
            "₂": 33,
            "₃": 33,
            "₄": 33,
            "₅": 33,
            "₆": 33,
            "₇": 33,
            "₈": 33,
            "₉": 33,
            "⁰": 33,
            "¹": 33,
            "²": 33,
            "³": 33,
            "⁴": 33,
            "⁵": 33,
            "⁶": 33,
            "⁷": 33,
            "⁸": 33,
            "⁹": 33,
            "‑": 37,
            "–": 58,
            "—": 80,
            "…": 77,
            "‘": 22,
            "’": 22,
            "“": 39,
            "”": 39,
            "°": 42,
            "→": 100,
            "≤": 58,
            "≥": 58,
            "£": 58,
            º: 40,
            µ: 66,
        },
        // italic
        {
            "0": 58,
            "1": 58,
            "2": 58,
            "3": 58,
            "4": 58,
            "5": 58,
            "6": 53,
            "7": 58,
            "8": 58,
            "9": 58,
            " ": 23,
            "!": 25,
            '"': 35,
            "#": 58,
            $: 58,
            "%": 74,
            "&": 66,
            "'": 19,
            "(": 26,
            ")": 26,
            "*": 40,
            "+": 58,
            ",": 22,
            "-": 35,
            ".": 23,
            "/": 42,
            ":": 25,
            ";": 26,
            "<": 58,
            "=": 58,
            ">": 58,
            "?": 42,
            "@": 77,
            A: 63,
            B: 60,
            C: 62,
            D: 71,
            E: 54,
            F: 53,
            G: 68,
            H: 71,
            I: 27,
            J: 40,
            K: 62,
            L: 48,
            M: 86,
            N: 71,
            O: 75,
            P: 56,
            Q: 75,
            R: 58,
            S: 51,
            T: 55,
            U: 69,
            V: 63,
            W: 96,
            X: 61,
            Y: 58,
            Z: 56,
            "[": 29,
            "\\": 41,
            "]": 29,
            "^": 58,
            _: 44,
            "`": 37,
            a: 51,
            b: 53,
            c: 45,
            d: 53,
            e: 48,
            f: 32,
            g: 48,
            h: 53,
            i: 23,
            j: 23,
            k: 47,
            l: 23,
            m: 79,
            n: 53,
            o: 52,
            p: 53,
            q: 51,
            r: 34,
            s: 40,
            t: 35,
            u: 53,
            v: 48,
            w: 72,
            x: 46,
            y: 48,
            z: 42,
            "{": 28,
            "|": 26,
            "}": 28,
            "~": 58,
            "₀": 33,
            "₁": 33,
            "₂": 33,
            "₃": 33,
            "₄": 33,
            "₅": 33,
            "₆": 33,
            "₇": 33,
            "₈": 33,
            "₉": 33,
            "⁰": 33,
            "¹": 33,
            "²": 33,
            "³": 33,
            "⁴": 33,
            "⁵": 33,
            "⁶": 33,
            "⁷": 33,
            "⁸": 33,
            "⁹": 33,
            "‑": 35,
            "–": 58,
            "—": 74,
            "…": 75,
            "‘": 20,
            "’": 21,
            "“": 34,
            "”": 35,
            "°": 41,
            "→": 100,
            "≤": 58,
            "≥": 58,
            "£": 58,
            º: 38,
            µ: 61,
        },
        // bold+italic
        {
            "0": 58,
            "1": 58,
            "2": 58,
            "3": 58,
            "4": 58,
            "5": 58,
            "6": 53,
            "7": 58,
            "8": 58,
            "9": 58,
            " ": 22,
            "!": 27,
            '"': 37,
            "#": 58,
            $: 58,
            "%": 76,
            "&": 67,
            "'": 20,
            "(": 27,
            ")": 27,
            "*": 40,
            "+": 58,
            ",": 24,
            "-": 35,
            ".": 24,
            "/": 43,
            ":": 26,
            ";": 27,
            "<": 58,
            "=": 58,
            ">": 58,
            "?": 43,
            "@": 77,
            A: 65,
            B: 61,
            C: 62,
            D: 71,
            E: 54,
            F: 53,
            G: 68,
            H: 72,
            I: 28,
            J: 41,
            K: 64,
            L: 48,
            M: 88,
            N: 72,
            O: 75,
            P: 58,
            Q: 75,
            R: 60,
            S: 52,
            T: 56,
            U: 69,
            V: 65,
            W: 97,
            X: 63,
            Y: 61,
            Z: 56,
            "[": 30,
            "\\": 43,
            "]": 30,
            "^": 58,
            _: 44,
            "`": 37,
            a: 52,
            b: 54,
            c: 45,
            d: 54,
            e: 49,
            f: 33,
            g: 50,
            h: 54,
            i: 25,
            j: 24,
            k: 50,
            l: 24,
            m: 79,
            n: 54,
            o: 52,
            p: 54,
            q: 52,
            r: 35,
            s: 41,
            t: 37,
            u: 54,
            v: 49,
            w: 74,
            x: 49,
            y: 49,
            z: 43,
            "{": 29,
            "|": 27,
            "}": 29,
            "~": 58,
            "₀": 33,
            "₁": 33,
            "₂": 33,
            "₃": 33,
            "₄": 33,
            "₅": 33,
            "₆": 33,
            "₇": 33,
            "₈": 33,
            "₉": 33,
            "⁰": 33,
            "¹": 33,
            "²": 33,
            "³": 33,
            "⁴": 33,
            "⁵": 33,
            "⁶": 33,
            "⁷": 33,
            "⁸": 33,
            "⁹": 33,
            "‑": 35,
            "–": 58,
            "—": 74,
            "…": 77,
            "‘": 21,
            "’": 21,
            "“": 36,
            "”": 36,
            "°": 41,
            "→": 100,
            "≤": 58,
            "≥": 58,
            "£": 58,
            º: 37,
            µ: 62,
        },
    ],
    [FontFamily.PlayfairDisplay]: [
        // regular
        {
            "0": 60,
            "1": 37,
            "2": 48,
            "3": 45,
            "4": 49,
            "5": 42,
            "6": 52,
            "7": 41,
            "8": 52,
            "9": 51,
            " ": 25,
            "!": 26,
            '"': 30,
            "#": 64,
            $: 52,
            "%": 74,
            "&": 84,
            "'": 19,
            "(": 29,
            ")": 29,
            "*": 49,
            "+": 59,
            ",": 26,
            "-": 50,
            ".": 25,
            "/": 37,
            ":": 27,
            ";": 29,
            "<": 61,
            "=": 65,
            ">": 61,
            "?": 46,
            "@": 88,
            A: 63,
            B: 62,
            C: 69,
            D: 72,
            E: 61,
            F: 57,
            G: 70,
            H: 76,
            I: 34,
            J: 33,
            K: 66,
            L: 59,
            M: 87,
            N: 71,
            O: 74,
            P: 59,
            Q: 74,
            R: 65,
            S: 54,
            T: 62,
            U: 68,
            V: 63,
            W: 91,
            X: 63,
            Y: 59,
            Z: 59,
            "[": 30,
            "\\": 37,
            "]": 30,
            "^": 54,
            _: 59,
            "`": 28,
            a: 50,
            b: 56,
            c: 49,
            d: 58,
            e: 51,
            f: 33,
            g: 53,
            h: 59,
            i: 29,
            j: 27,
            k: 55,
            l: 29,
            m: 89,
            n: 60,
            o: 55,
            p: 58,
            q: 56,
            r: 45,
            s: 45,
            t: 35,
            u: 58,
            v: 49,
            w: 77,
            x: 52,
            y: 50,
            z: 48,
            "{": 30,
            "|": 22,
            "}": 30,
            "~": 65,
            "₀": 45,
            "₁": 26,
            "₂": 34,
            "₃": 32,
            "₄": 36,
            "₅": 32,
            "₆": 38,
            "₇": 31,
            "₈": 37,
            "₉": 38,
            "⁰": 45,
            "¹": 26,
            "²": 34,
            "³": 32,
            "⁴": 36,
            "⁵": 32,
            "⁶": 38,
            "⁷": 31,
            "⁸": 37,
            "⁹": 39,
            "‑": 50,
            "–": 57,
            "—": 86,
            "…": 81,
            "‘": 25,
            "’": 25,
            "“": 42,
            "”": 42,
            "°": 33,
            "→": 68,
            "≤": 64,
            "≥": 64,
            "£": 60,
            º: 45,
            µ: 58,
        },
        // bold
        {
            "0": 65,
            "1": 38,
            "2": 52,
            "3": 49,
            "4": 53,
            "5": 46,
            "6": 56,
            "7": 46,
            "8": 56,
            "9": 55,
            " ": 23,
            "!": 29,
            '"': 37,
            "#": 62,
            $: 57,
            "%": 73,
            "&": 90,
            "'": 21,
            "(": 32,
            ")": 32,
            "*": 48,
            "+": 57,
            ",": 27,
            "-": 48,
            ".": 27,
            "/": 37,
            ":": 29,
            ";": 30,
            "<": 60,
            "=": 64,
            ">": 60,
            "?": 51,
            "@": 88,
            A: 67,
            B: 67,
            C: 71,
            D: 78,
            E: 63,
            F: 59,
            G: 74,
            H: 80,
            I: 38,
            J: 36,
            K: 71,
            L: 61,
            M: 93,
            N: 72,
            O: 79,
            P: 64,
            Q: 79,
            R: 69,
            S: 58,
            T: 67,
            U: 69,
            V: 67,
            W: 97,
            X: 69,
            Y: 62,
            Z: 60,
            "[": 32,
            "\\": 37,
            "]": 32,
            "^": 53,
            _: 59,
            "`": 30,
            a: 52,
            b: 59,
            c: 50,
            d: 60,
            e: 50,
            f: 35,
            g: 55,
            h: 61,
            i: 32,
            j: 30,
            k: 59,
            l: 31,
            m: 91,
            n: 61,
            o: 57,
            p: 60,
            q: 59,
            r: 47,
            s: 46,
            t: 35,
            u: 61,
            v: 51,
            w: 79,
            x: 54,
            y: 52,
            z: 47,
            "{": 33,
            "|": 25,
            "}": 33,
            "~": 67,
            "₀": 45,
            "₁": 28,
            "₂": 35,
            "₃": 33,
            "₄": 37,
            "₅": 32,
            "₆": 39,
            "₇": 32,
            "₈": 38,
            "₉": 39,
            "⁰": 45,
            "¹": 28,
            "²": 35,
            "³": 33,
            "⁴": 37,
            "⁵": 32,
            "⁶": 39,
            "⁷": 32,
            "⁸": 38,
            "⁹": 39,
            "‑": 48,
            "–": 60,
            "—": 90,
            "…": 83,
            "‘": 26,
            "’": 25,
            "“": 46,
            "”": 46,
            "°": 31,
            "→": 68,
            "≤": 62,
            "≥": 62,
            "£": 66,
            º: 47,
            µ: 58,
        },
        // italic
        {
            "0": 57,
            "1": 34,
            "2": 50,
            "3": 49,
            "4": 52,
            "5": 46,
            "6": 53,
            "7": 49,
            "8": 54,
            "9": 51,
            " ": 25,
            "!": 26,
            '"': 30,
            "#": 64,
            $: 55,
            "%": 77,
            "&": 82,
            "'": 19,
            "(": 36,
            ")": 36,
            "*": 50,
            "+": 59,
            ",": 25,
            "-": 50,
            ".": 24,
            "/": 47,
            ":": 28,
            ";": 29,
            "<": 60,
            "=": 66,
            ">": 60,
            "?": 44,
            "@": 85,
            A: 63,
            B: 63,
            C: 67,
            D: 73,
            E: 61,
            F: 57,
            G: 71,
            H: 76,
            I: 34,
            J: 64,
            K: 68,
            L: 59,
            M: 87,
            N: 77,
            O: 73,
            P: 59,
            Q: 78,
            R: 66,
            S: 55,
            T: 66,
            U: 68,
            V: 63,
            W: 90,
            X: 70,
            Y: 67,
            Z: 65,
            "[": 30,
            "\\": 49,
            "]": 30,
            "^": 54,
            _: 74,
            "`": 32,
            a: 52,
            b: 50,
            c: 43,
            d: 54,
            e: 43,
            f: 32,
            g: 45,
            h: 54,
            i: 30,
            j: 28,
            k: 52,
            l: 28,
            m: 81,
            n: 58,
            o: 49,
            p: 55,
            q: 51,
            r: 43,
            s: 38,
            t: 34,
            u: 57,
            v: 53,
            w: 69,
            x: 53,
            y: 48,
            z: 45,
            "{": 31,
            "|": 32,
            "}": 31,
            "~": 65,
            "₀": 41,
            "₁": 25,
            "₂": 34,
            "₃": 33,
            "₄": 34,
            "₅": 31,
            "₆": 36,
            "₇": 32,
            "₈": 35,
            "₉": 36,
            "⁰": 40,
            "¹": 25,
            "²": 34,
            "³": 33,
            "⁴": 34,
            "⁵": 31,
            "⁶": 34,
            "⁷": 32,
            "⁸": 35,
            "⁹": 34,
            "‑": 50,
            "–": 73,
            "—": 100,
            "…": 81,
            "‘": 24,
            "’": 24,
            "“": 40,
            "”": 40,
            "°": 34,
            "→": 68,
            "≤": 65,
            "≥": 64,
            "£": 62,
            º: 41,
            µ: 58,
        },
        // bold+italic
        {
            "0": 62,
            "1": 37,
            "2": 54,
            "3": 52,
            "4": 54,
            "5": 47,
            "6": 57,
            "7": 50,
            "8": 58,
            "9": 55,
            " ": 26,
            "!": 31,
            '"': 39,
            "#": 63,
            $: 61,
            "%": 80,
            "&": 86,
            "'": 23,
            "(": 40,
            ")": 40,
            "*": 48,
            "+": 58,
            ",": 29,
            "-": 51,
            ".": 28,
            "/": 46,
            ":": 31,
            ";": 32,
            "<": 59,
            "=": 65,
            ">": 60,
            "?": 49,
            "@": 86,
            A: 65,
            B: 68,
            C: 69,
            D: 77,
            E: 63,
            F: 59,
            G: 74,
            H: 81,
            I: 39,
            J: 68,
            K: 74,
            L: 61,
            M: 92,
            N: 83,
            O: 78,
            P: 64,
            Q: 83,
            R: 71,
            S: 59,
            T: 68,
            U: 69,
            V: 66,
            W: 98,
            X: 74,
            Y: 73,
            Z: 66,
            "[": 36,
            "\\": 49,
            "]": 36,
            "^": 53,
            _: 74,
            "`": 32,
            a: 56,
            b: 55,
            c: 46,
            d: 58,
            e: 47,
            f: 34,
            g: 47,
            h: 57,
            i: 32,
            j: 30,
            k: 55,
            l: 30,
            m: 86,
            n: 60,
            o: 53,
            p: 58,
            q: 55,
            r: 47,
            s: 42,
            t: 35,
            u: 60,
            v: 53,
            w: 68,
            x: 57,
            y: 48,
            z: 46,
            "{": 36,
            "|": 37,
            "}": 36,
            "~": 65,
            "₀": 44,
            "₁": 27,
            "₂": 36,
            "₃": 34,
            "₄": 36,
            "₅": 33,
            "₆": 38,
            "₇": 33,
            "₈": 39,
            "₉": 38,
            "⁰": 44,
            "¹": 27,
            "²": 36,
            "³": 34,
            "⁴": 36,
            "⁵": 32,
            "⁶": 37,
            "⁷": 34,
            "⁸": 39,
            "⁹": 37,
            "‑": 51,
            "–": 69,
            "—": 98,
            "…": 84,
            "‘": 27,
            "’": 27,
            "“": 47,
            "”": 46,
            "°": 33,
            "→": 68,
            "≤": 63,
            "≥": 62,
            "£": 67,
            º: 49,
            µ: 58,
        },
    ],
}

interface StringWidthSettings {
    font?: FontFamily
    size?: number
    bold?: boolean
    italic?: boolean
}

const getPixelWidth = (
    string: string,
    settings: StringWidthSettings
): number => {
    const font = settings.font ?? FontFamily.Lato
    const size = settings.size ?? 100
    const variant = (settings.bold ? 1 : 0) + (settings.italic ? 2 : 0)

    const fontVariants = widthsMap[font]
    if (!fontVariants) {
        throw new Error(
            `This font is not supported. Supported fonts are: ${Object.values(FontFamily).join(", ")}`
        )
    }

    // Get the map for this font+variant combination
    const charWidths = fontVariants[variant]
    let totalWidth = 0

    // Normalize to decompose accented characters (é -> e + combining accent ´)
    // then skip combining marks (U+0300-U+036F) and control characters
    const normalized = string.normalize("NFD")
    const len = normalized.length

    for (let i = 0; i < len; i++) {
        const code = normalized.charCodeAt(i)

        // Skip control characters (0x00-0x1F) and combining diacritical marks (0x0300-0x036F)
        if (code <= 0x1f || (code >= 0x0300 && code <= 0x036f)) {
            continue
        }

        // if we don't have a width for the character, use the width of 'x' as a fallback
        totalWidth += charWidths[normalized[i]] ?? charWidths["x"]
    }

    return totalWidth * (size / 100)
}

export { getPixelWidth }
