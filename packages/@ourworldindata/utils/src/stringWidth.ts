/**
 * This file contains an adapted version of https://github.com/adambisek/string-pixel-width,
 * just with the character widths hardcoded for our two main fonts (Lato and Playfair Display).
 * It can be used to roughly estimate the width of a string in pixels.
 */

import { deburr } from "lodash-es"

type SupportedFonts = "lato" | "playfair display"

const widthsMap: Record<SupportedFonts, Record<string, number[]>> = {
    lato: {
        "0": [58, 58, 58, 58],
        "1": [58, 58, 58, 58],
        "2": [58, 58, 58, 58],
        "3": [58, 58, 58, 58],
        "4": [58, 58, 58, 58],
        "5": [58, 58, 58, 58],
        "6": [58, 58, 53, 53],
        "7": [58, 58, 58, 58],
        "8": [58, 58, 58, 58],
        "9": [58, 58, 58, 58],
        " ": [26, 24, 23, 22],
        "!": [27, 28, 25, 27],
        '"': [37, 40, 35, 37],
        "#": [58, 58, 58, 58],
        $: [58, 58, 58, 58],
        "%": [80, 82, 74, 76],
        "&": [71, 72, 66, 67],
        "'": [20, 21, 19, 20],
        "(": [27, 27, 26, 27],
        ")": [27, 27, 26, 27],
        "*": [43, 43, 40, 40],
        "+": [58, 58, 58, 58],
        ",": [23, 23, 22, 24],
        "-": [37, 37, 35, 35],
        ".": [24, 24, 23, 24],
        "/": [45, 47, 42, 43],
        ":": [25, 26, 25, 26],
        ";": [26, 27, 26, 27],
        "<": [58, 58, 58, 58],
        "=": [58, 58, 58, 58],
        ">": [58, 58, 58, 58],
        "?": [45, 46, 42, 43],
        "@": [84, 84, 77, 77],
        A: [68, 69, 63, 65],
        B: [65, 66, 60, 61],
        C: [67, 66, 62, 62],
        D: [76, 76, 71, 71],
        E: [58, 58, 54, 54],
        F: [57, 57, 53, 53],
        G: [73, 73, 68, 68],
        H: [76, 77, 71, 72],
        I: [28, 30, 27, 28],
        J: [42, 43, 40, 41],
        K: [66, 69, 62, 64],
        L: [51, 52, 48, 48],
        M: [93, 95, 86, 88],
        N: [76, 77, 71, 72],
        O: [80, 81, 75, 75],
        P: [60, 62, 56, 58],
        Q: [80, 81, 75, 75],
        R: [63, 64, 58, 60],
        S: [54, 55, 51, 52],
        T: [59, 60, 55, 56],
        U: [74, 74, 69, 69],
        V: [68, 69, 63, 65],
        W: [104, 105, 96, 97],
        X: [65, 67, 61, 63],
        Y: [62, 65, 58, 61],
        Z: [60, 61, 56, 56],
        "[": [31, 31, 29, 30],
        "\\": [45, 47, 41, 43],
        "]": [31, 31, 29, 30],
        "^": [58, 58, 58, 58],
        _: [46, 47, 44, 44],
        "`": [40, 40, 37, 37],
        a: [50, 51, 51, 52],
        b: [56, 57, 53, 54],
        c: [48, 48, 45, 45],
        d: [56, 57, 53, 54],
        e: [53, 53, 48, 49],
        f: [35, 36, 32, 33],
        g: [52, 53, 48, 50],
        h: [56, 56, 53, 54],
        i: [24, 25, 23, 25],
        j: [24, 25, 23, 24],
        k: [51, 53, 47, 50],
        l: [24, 25, 23, 24],
        m: [82, 84, 79, 79],
        n: [56, 56, 53, 54],
        o: [57, 57, 52, 52],
        p: [56, 57, 53, 54],
        q: [56, 57, 51, 52],
        r: [36, 37, 34, 35],
        s: [43, 44, 40, 41],
        t: [36, 37, 35, 37],
        u: [56, 56, 53, 54],
        v: [52, 53, 48, 49],
        w: [79, 80, 72, 74],
        x: [50, 52, 46, 49],
        y: [52, 53, 48, 49],
        z: [45, 46, 42, 43],
        "{": [30, 31, 28, 29],
        "|": [25, 26, 26, 27],
        "}": [30, 31, 28, 29],
        "~": [58, 58, 58, 58],
    },
    "playfair display": {
        "0": [60, 65, 57, 62],
        "1": [37, 38, 34, 37],
        "2": [48, 52, 50, 54],
        "3": [45, 49, 49, 52],
        "4": [49, 53, 52, 54],
        "5": [42, 46, 46, 47],
        "6": [52, 56, 53, 57],
        "7": [41, 46, 49, 50],
        "8": [52, 56, 54, 58],
        "9": [51, 55, 51, 55],
        " ": [25, 23, 25, 26],
        "!": [26, 29, 26, 31],
        '"': [30, 37, 30, 39],
        "#": [64, 62, 64, 63],
        $: [52, 57, 55, 61],
        "%": [74, 73, 77, 80],
        "&": [84, 90, 82, 86],
        "'": [19, 21, 19, 23],
        "(": [29, 32, 36, 40],
        ")": [29, 32, 36, 40],
        "*": [49, 48, 50, 48],
        "+": [59, 57, 59, 58],
        ",": [26, 27, 25, 29],
        "-": [50, 48, 50, 51],
        ".": [25, 27, 24, 28],
        "/": [37, 37, 47, 46],
        ":": [27, 29, 28, 31],
        ";": [29, 30, 29, 32],
        "<": [61, 60, 60, 59],
        "=": [65, 64, 66, 65],
        ">": [61, 60, 60, 60],
        "?": [46, 51, 44, 49],
        "@": [88, 88, 85, 86],
        A: [63, 67, 63, 65],
        B: [62, 67, 63, 68],
        C: [69, 71, 67, 69],
        D: [72, 78, 73, 77],
        E: [61, 63, 61, 63],
        F: [57, 59, 57, 59],
        G: [70, 74, 71, 74],
        H: [76, 80, 76, 81],
        I: [34, 38, 34, 39],
        J: [33, 36, 64, 68],
        K: [66, 71, 68, 74],
        L: [59, 61, 59, 61],
        M: [87, 93, 87, 92],
        N: [71, 72, 77, 83],
        O: [74, 79, 73, 78],
        P: [59, 64, 59, 64],
        Q: [74, 79, 78, 83],
        R: [65, 69, 66, 71],
        S: [54, 58, 55, 59],
        T: [62, 67, 66, 68],
        U: [68, 69, 68, 69],
        V: [63, 67, 63, 66],
        W: [91, 97, 90, 98],
        X: [63, 69, 70, 74],
        Y: [59, 62, 67, 73],
        Z: [59, 60, 65, 66],
        "[": [30, 32, 30, 36],
        "\\": [37, 37, 49, 49],
        "]": [30, 32, 30, 36],
        "^": [54, 53, 54, 53],
        _: [59, 59, 74, 74],
        "`": [28, 30, 32, 32],
        a: [50, 52, 52, 56],
        b: [56, 59, 50, 55],
        c: [49, 50, 43, 46],
        d: [58, 60, 54, 58],
        e: [51, 50, 43, 47],
        f: [33, 35, 32, 34],
        g: [53, 55, 45, 47],
        h: [59, 61, 54, 57],
        i: [29, 32, 30, 32],
        j: [27, 30, 28, 30],
        k: [55, 59, 52, 55],
        l: [29, 31, 28, 30],
        m: [89, 91, 81, 86],
        n: [60, 61, 58, 60],
        o: [55, 57, 49, 53],
        p: [58, 60, 55, 58],
        q: [56, 59, 51, 55],
        r: [45, 47, 43, 47],
        s: [45, 46, 38, 42],
        t: [35, 35, 34, 35],
        u: [58, 61, 57, 60],
        v: [49, 51, 53, 53],
        w: [77, 79, 69, 68],
        x: [52, 54, 53, 57],
        y: [50, 52, 48, 48],
        z: [48, 47, 45, 46],
        "{": [30, 33, 31, 36],
        "|": [22, 25, 32, 37],
        "}": [30, 33, 31, 36],
        "~": [65, 67, 65, 65],
    },
} as const

interface StringWidthSettings {
    font?: SupportedFonts
    size?: number
    bold?: boolean
    italic?: boolean
}

const settingsDefaults = {
    font: "lato",
    size: 100,
} satisfies StringWidthSettings

const getPixelWidth = (
    string: string,
    settings: StringWidthSettings
): number => {
    const sett = { ...settingsDefaults, ...settings }
    const font = sett.font.toLowerCase() as SupportedFonts
    const size = sett.size
    const variant = 0 + (sett.bold ? 1 : 0) + (sett.italic ? 2 : 0)
    const available = Object.keys(widthsMap)
    if (available.indexOf(font) === -1) {
        throw new Error(
            `This font is not supported. Supported fonts are: ${available.join(", ")}`
        )
    }
    let totalWidth = 0
    deburr(string)
        .split("")
        .forEach((char) => {
            // eslint-disable-next-line no-control-regex
            if (/[\x00-\x1F]/.test(char)) {
                // non-printable character
                return true
            }
            // use width of 'x' as fallback for unregistered char
            const widths = widthsMap[font][char] || widthsMap[font].x
            const width = widths[variant]
            totalWidth += width
            return true
        })
    return totalWidth * (size / 100)
}

export { getPixelWidth }
